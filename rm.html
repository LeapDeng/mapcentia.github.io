<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Map with custom Awesome Markers and pop-up</title>
    <script src="http://gc2.mapcentia.com/api/v3/js/geocloud.php"></script>
    <script src="https://rawgit.com/mapshakers/leaflet-icon-pulse/master/src/L.Icon.Pulse.js"></script>
    <link rel="stylesheet" href="https://rawgit.com/mapshakers/leaflet-icon-pulse/master/src/L.Icon.Pulse.css"/>
    <style>body, html {
        margin: 0; padding: 0;
    }</style>
</head>
<body>
<div style="width: 100%;height: 100%; position: absolute" id="map"></div>
</body>
<script>
    // Initiate a geocloud object
    var gc2 = new geocloud.map({
        el: "map"
    });

    var clickedCoord;

    // Add a base layer
    gc2.addBaseLayer("osm");

    // Set a base layer active
    gc2.setBaseLayer("osm");

    var pulsingIcon = L.icon.pulse({iconSize: [10, 10], color: 'red'});

    var pulseGroup = new L.FeatureGroup();
    var lineGroup = new L.FeatureGroup();

    pulseGroup.addTo(gc2.map);
    lineGroup.addTo(gc2.map);


    // Create a GeoJSON store with a SELECT query
    var projects = new geocloud.geoJsonStore({
        db: "regionmidt",
        sql: "SELECT * FROM int.projects",

        // Cache the SELECT query on the server for an hour
        lifetime: 3600,


        // Bind a popup to each point
        onEachFeature: function (feature, layer) {
            layer.bindPopup(feature.properties['partnerorg']);
            layer.on({
                click: function (e) {
                    //console.info(feature.properties.projektid);
                    //console.info(partners.layer);
                    pulseGroup.clearLayers();
                    lineGroup.clearLayers();
                    partners.layer.eachLayer(function (l) {
                        if (l.feature.properties.projektid === feature.properties.projektid) {
                            L.marker(l.getLayers()[0].getLatLng(), {icon: pulsingIcon}).addTo(pulseGroup);
                            new L.Polyline([e.latlng,l.getLayers()[0].getLatLng()], {
                                color: 'red',
                                weight: 1,
                                opacity: 0.5,
                                smoothFactor: 1
                            }).addTo(lineGroup);
                        }
                    });
                    gc2.map.fitBounds(pulseGroup.getBounds());
                }
            });
        },

        // Make Awesome Markers instead of simple vector point features
        pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {
                icon: L.AwesomeMarkers.icon({
                            icon: 'star',
                            markerColor: 'blue',
                            prefix: 'fa'
                        }
                )
            });
        },

        onLoad: function () {

            // Zoom to vector layer
            gc2.zoomToExtentOfgeoJsonStore(this);
        }
    });


    // Create a GeoJSON store with a SELECT query
    var partners = new geocloud.geoJsonStore({
        db: "regionmidt",
        sql: "SELECT * FROM int.partners",

        // Cache the SELECT query on the server for an hour
        lifetime: 3600,

        styleMap: function () {
            return {
                color: "#ff0000"
            }
        },

        pointToLayer: function(feature, latlng) {
            return new L.CircleMarker(latlng, {radius: 5, fillOpacity: 1});
        },


        // Bind a popup to each point
        onEachFeature: function (feature, layer) {
            layer.bindPopup(feature.properties['partnerorg']);
        },

        // Make Awesome Markers instead of simple vector point features
        /*   pointToLayer: function (feature, latlng) {
         return L.marker(latlng, {
         icon: L.AwesomeMarkers.icon({
         icon: 'star',
         markerColor: 'red',
         prefix: 'fa'
         }
         )
         });
         },*/

        onLoad: function () {

            // Zoom to vector layer
            //gc2.zoomToExtentOfgeoJsonStore(this);
            projects.load();

        }
    });

    // Add the store as a vector overlay
    gc2.addGeoJsonStore(partners);
    gc2.addGeoJsonStore(projects);


    // Run the SQL and load the data
    partners.load();
</script>
</html>
